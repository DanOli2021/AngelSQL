<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AngelSQL Command Interface</title>
    <link rel="stylesheet" href="bootstrap-5.3.0/css/bootstrap.min.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/monokai.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>

    <script src="js/AngelSQL.js"></script>
    <script src="js/main.js"></script>
    <link href="css/sql_commands.css" rel="stylesheet" />

    <script>

        let result = sessionStorage.getItem("AngelSQLTocken");

        if (result == null) {
            window.location.href = "index.html";
        }

        let db = new AngelSQL("", "", window.location.protocol + '//' + window.location.host + "/AngelSQL");
        db.SetToken(result);

    </script>

</head>

<body>


    <div class="container">
        <div class="row col-12">
        </div>
    </div>


    <!-- Modal Bootstrap -->
    <div class="modal fade" id="changeMasterModal" tabindex="-1" aria-labelledby="changeMasterModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeMasterModalLabel">Cambiar Usuario Máster</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <form id="changeMasterForm">
                        <div class="mb-3">
                            <label for="newMasterUser" class="form-label">New user</label>
                            <input type="text" class="form-control" id="newMasterUser" required>
                        </div>
                        <div class="mb-3">
                            <label for="newMasterPassword" class="form-label">New password</label>
                            <input type="password" class="form-control" id="newMasterPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmMasterPassword" class="form-label">Retype password</label>
                            <input type="password" class="form-control" id="confirmMasterPassword" required>
                        </div>
                        <div id="changeMasterMsg" class="text-danger small"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyChangeMaster()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Bootstrap -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 2000">
        <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Change made successfully.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
        </div>
    </div>


    <dialog id="dialog_accept" style="padding:20px; border-radius:10px;">
        <h4 id="dialog_accept_title"></h4>
        <p id="dialog_accept_message"></p>
        <div class="mt-3 d-flex justify-content-end">
            <button id="dialog_button_accept" class="btn btn-primary me-2">Accept</button>
            <button class="btn btn-secondary" onclick="ShowAcceptCancelDialogClose()">Cancel</button>
        </div>
    </dialog>


    <h1>AngelSQL Command Interface</h1>

    <textarea rows="5" id="sqlCommand">
    </textarea>

    <div class="container-fluid">
        <div class="row col-12">
            <div class="col-3 btn-container">
                <button id="btnChangeMaster" class="btn" onclick="executeAngelSQLCommand()">Execute (F2)</button>
            </div>

            <div class="col-3 btn-container" style="margin-bottom: 10px">
                <button class="btn" onclick="showChangeMasterModal()">Change master user</button>
            </div>

            <div class="col-3 btn-container" style="margin-bottom: 10px">
                <button class="btn">Manage Accounts</button>
            </div>

            <div class="col-3 btn-container" style="margin-bottom: 10px">
                <button class="btn">Create App</button>
            </div>
        </div>
    </div>

    <br />

    <div id="resultsContainer"></div>

    <script>

        function autoResizeTextArea(textArea) {
            setTimeout(() => {
                textArea.style.height = 'auto';
                textArea.style.height = textArea.scrollHeight + 'px';
            }, 0);
        }

        // Función para obtener parámetros de la URL
        function getQueryParam(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        function executeAngelSQLCommand() {
            const sqlCommand = document.getElementById("sqlCommand").value;

            if (sqlCommand === null) return;
            if (sqlCommand.trim() === "") return;

            const currentDate = new Date();
            const dateString = currentDate.toLocaleString();

            const resultBlock = document.createElement("div");
            resultBlock.classList.add("resultBlock");

            const resultDate = document.createElement("div");
            resultDate.classList.add("resultDate");
            resultDate.textContent = `Date: ${dateString}`;

            const resultCommand = document.createElement("textarea");
            resultCommand.classList.add("resultCommand");
            resultCommand.setAttribute("rows", "1");
            resultCommand.value = sqlCommand;
            resultCommand.readOnly = true;

            const resultOutput = document.createElement("div");
            resultOutput.classList.add("resultOutput");
            resultOutput.textContent = "Thinking...";

            console.log(sqlCommand);
            result = db.Prompt("BATCH " + sqlCommand + " SHOW IN CONSOLE");

            let dotCount = 0;
            const dotInterval = setInterval(() => {
                resultOutput.textContent += '.';
                dotCount++;
                if (dotCount >= 5) {
                    resultOutput.textContent = "Thinking";
                    dotCount = 0;
                }
            }, 500); // Añade un punto cada 500 milisegundos

            result.then(function (value) {
                clearInterval(dotInterval); // Detenemos la animación

                setTimeout(function () { // Añadimos el retraso
                    resultOutput.textContent = ""

                    const codeBlockRegex = /```([a-z]*)\n([\s\S]*?)```/g;  // Regex para detectar bloques de código y lenguaje
                    let match;
                    let lastIndex = 0;
                    while ((match = codeBlockRegex.exec(value)) !== null) {
                        const beforeCode = value.slice(lastIndex, match.index);
                        const language = match[1]; // Aquí obtenemos el lenguaje
                        const code = match[2]; // Y aquí obtenemos el código
                        lastIndex = codeBlockRegex.lastIndex;

                        if (beforeCode.trim()) {
                            const beforeCodeDiv = document.createElement("div");
                            beforeCodeDiv.textContent = beforeCode;
                            beforeCodeDiv.style.fontFamily = 'Arial';
                            beforeCodeDiv.style.fontSize = '11pt';
                            beforeCodeDiv.style.fontWeight = 'bold';
                            beforeCodeDiv.style.whiteSpace = 'pre-wrap';
                            beforeCodeDiv.style.overflowWrap = 'break-word';

                            const beforeCodeCopyBtn = document.createElement("button");
                            beforeCodeCopyBtn.textContent = "\uD83D\uDCCB"; // Emoji de portapapeles

                            beforeCodeCopyBtn.classList.add("copyBtn");
                            beforeCodeCopyBtn.addEventListener("click", function () {
                                copyToClipboard(beforeCode);
                            });
                            beforeCodeDiv.appendChild(beforeCodeCopyBtn);

                            resultOutput.appendChild(beforeCodeDiv);
                        }

                        const codeDiv = document.createElement("div");
                        codeDiv.textContent = code;
                        hljs.highlightBlock(codeDiv);

                        const codeCopyBtn = document.createElement("button");
                        codeCopyBtn.textContent = "\uD83D\uDCCB Copy code"; // Emoji de portapapeles

                        codeCopyBtn.style.fontFamily = 'Arial';
                        codeCopyBtn.style.fontSize = '11pt';
                        codeCopyBtn.style.fontWeight = 'bold';
                        codeCopyBtn.style.backgroundColor = 'white';
                        codeCopyBtn.style.position = "relative";
                        codeCopyBtn.style.float = "left";

                        codeCopyBtn.classList.add("copyBtn");
                        codeCopyBtn.addEventListener("click", function () {
                            copyToClipboard(code);
                        });
                        codeDiv.appendChild(codeCopyBtn);

                        resultOutput.appendChild(codeDiv);
                    }

                    const afterCode = value.slice(lastIndex);
                    if (afterCode.trim()) {
                        const afterCodeDiv = document.createElement("div");
                        afterCodeDiv.textContent = afterCode;

                        afterCodeDiv.style.fontFamily = 'Arial';
                        afterCodeDiv.style.fontSize = '11pt';
                        afterCodeDiv.style.fontWeight = 'bold';
                        afterCodeDiv.style.whiteSpace = 'pre-wrap';
                        afterCodeDiv.style.overflowWrap = 'break-word';

                        const afterCodeCopyBtn = document.createElement("button");
                        afterCodeCopyBtn.textContent = "\uD83D\uDCCB"; // Emoji de portapapeles
                        afterCodeCopyBtn.classList.add("copyBtn");
                        afterCodeCopyBtn.addEventListener("click", function () {
                            copyToClipboard(afterCode);
                        });
                        afterCodeDiv.appendChild(afterCodeCopyBtn);

                        resultOutput.appendChild(afterCodeDiv);
                    }

                }, 500);


            }).catch(function (error) {
                clearInterval(dotInterval); // Detenemos la animación
                resultOutput.textContent = "Error: " + error;
            });

            autoResizeTextArea(resultCommand);

            resultBlock.appendChild(resultDate);
            resultBlock.appendChild(resultCommand);
            resultBlock.appendChild(resultOutput);

            const resultsContainer = document.getElementById("resultsContainer");
            resultsContainer.insertBefore(resultBlock, resultsContainer.firstChild);

            document.getElementById("sqlCommand").value = "";
            document.getElementById("sqlCommand").focus();

            resultsContainer.scrollTop = 0;
        }

        function copyToClipboard(text) {
            const tempTextArea = document.createElement("textarea");
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand("copy");
            document.body.removeChild(tempTextArea);
            alert("El texto ha sido copiado al portapapeles: " + text);
        }

        let changeMasterModal = null;

        function showChangeMasterModal() {
            const modalElement = document.getElementById('changeMasterModal');
            changeMasterModal = new bootstrap.Modal(modalElement);
            changeMasterModal.show();

            document.getElementById("changeMasterMsg").textContent = "";
            document.getElementById("changeMasterForm").reset();
        }

        function applyChangeMaster() {
            const user = document.getElementById("newMasterUser").value.trim();
            const pass = document.getElementById("newMasterPassword").value;
            const confirm = document.getElementById("confirmMasterPassword").value;
            const msg = document.getElementById("changeMasterMsg");

            msg.classList.remove("text-success", "text-danger");

            if (!user || !pass || !confirm) {
                msg.textContent = "Todos los campos son obligatorios.";
                msg.classList.add("text-danger");
                return;
            }

            if (pass !== confirm) {
                showDialog("Alert", "Las contraseñas no coinciden.")
                return;
            }

            const command = `CHANGE SEVER MASTER TO USER ${user} PASSWORD ${pass}`;

            ShowAcceptCancelDialog("Confirm change", `Are you sure you want to change the master user to ${user}?`, async function () {
                msg.textContent = "Procesando...";

                try {
                    const result = await db.Server(command);
                    if (result.startsWith("Error:")) {
                        msg.textContent = result;
                        msg.classList.add("text-danger");
                    } else {
                        msg.textContent = "Credentials updated successfully.";
                        msg.classList.add("text-success");

                        setTimeout(() => {
                            changeMasterModal.hide();
                            showSuccessToast();  // Mostramos el toast después de cerrar
                        }, 800);

                        ShowAcceptCancelDialogClose();

                    }
                } catch (err) {
                    msg.textContent = "Error: " + err;
                    msg.classList.add("text-danger");
                }
            });
        }

        // Cerrar modal con tecla ESC
        document.addEventListener("keydown", function (event) {
            if (event.key === "Escape") {
                closeChangeMasterModal();
            }
        });

        // Cerrar modal al hacer clic fuera de él
        window.addEventListener("click", function (event) {
            const modal = document.getElementById("changeMasterModal");
            if (event.target === modal) {
                closeChangeMasterModal();
            }
        });

        // Asegúrate de que se ejecute la función cuando se carga la página y cuando el contenido del textarea cambia
        document.addEventListener('DOMContentLoaded', () => {
            const textArea = document.getElementById('sqlCommand');

            if (textArea) {
                // Evento para ajustar el tamaño cuando el contenido del textarea cambia
                textArea.addEventListener('input', () => {
                    autoResizeTextArea(textArea);
                });

                // Ajustar el tamaño inicial al cargar la página
                autoResizeTextArea(textArea);
            }

            let warning = getQueryParam("warning")

            if (warning) {
                if (warning === "change_default_password") {
                    showDialog("Warning", "Warning: Change default password");
                }
            }


        });


        document.addEventListener('keydown', function (event) {
            // El identificador de tecla para F2 es "F2"
            if (event.key === "F2") {
                event.preventDefault();
                executeAngelSQLCommand();
            }
        });

        function showSuccessToast() {
            const toastEl = document.getElementById("successToast");
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }


        document.getElementById("sqlCommand").focus();

    </script>

    <script src="bootstrap-5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>

        if (getQueryParam('matrix') === '720328') {
            const canvas = document.createElement("canvas");
            canvas.id = "matrixCanvas";
            document.body.appendChild(canvas);

            const ctx = canvas.getContext("2d");
            canvas.style.position = "fixed";
            canvas.style.top = 0;
            canvas.style.left = 0;
            canvas.style.zIndex = "-1";
            canvas.style.width = "100%";
            canvas.style.height = "100%";
            canvas.style.pointerEvents = "none";

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const letters = "アァイィウヴエェオカガキギクグケゲコゴサザシジスズセゼソゾタダチッヂヅテデトドナニヌネノハバパヒビピフブプヘベペホボポマミムメモヤユヨラリルレロワンABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789$%#@!*&".split("");
            const fontSize = 14;
            const columns = canvas.width / fontSize;
            const drops = Array.from({ length: columns }, () => 1);

            function drawMatrix() {
                ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = "#33ff33";
                ctx.font = fontSize + "px Courier New";

                for (let i = 0; i < drops.length; i++) {
                    const text = letters[Math.floor(Math.random() * letters.length)];
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }

                    drops[i]++;
                }
            }

            setInterval(drawMatrix, 33);

            window.addEventListener("resize", () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }
    </script>



</body>
</html>